<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta name="format-detection" content="telephone=no">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#FFD6E0">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <title>CallWA</title>
  
  <!-- Depend√™ncias -->
  <script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5"></script>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      text-align: center;
      background: #fdf6f8;
      color: #222;
      transition: background 0.3s, color 0.3s;
    }
    .status {
      display: inline-block; width: 12px; height: 12px;
      border-radius: 50%; background: red;
    }
    .painel {
      max-width: 400px; margin: 20px auto; padding: 20px;
      border: 2px solid #ccc; border-radius: 12px; background: #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: background 0.3s;
    }
    input, button, select {
      width: 100%; margin: 5px 0; padding: 12px;
      font-size: 1rem; border: none; border-radius: 10px;
      background: #f3f3f3; font-weight: 500; transition: background 0.2s;
    }
    button { background: #FFD6E0; color: #333; cursor: pointer; }
    button:active { transform: scale(0.97); background: #ffb8c6; }
    .botoes-grid, .botoes-modo {
      display: grid; gap: 10px; margin-top: 10px;
    }
    .botoes-grid { grid-template-columns: repeat(3,1fr); }
    .botoes-modo { grid-template-columns: repeat(3,1fr); }
    .botoes-modo button.ativo { background: #ff3366; color: #fff; }
    .cor-preview {
      width: 50px; height: 50px; border-radius: 50%;
      margin: 10px auto; border: 1px solid #333; background: #FFD6E0;
    }
    #colorWheel {
      margin: 10px auto; display: flex; justify-content: center;
      animation: pulseWheel 2s infinite alternate;
    }
    .esp-status { margin-top: 10px; font-size: 0.9rem; }
    .esp-led {
      width: 16px; height: 16px; border-radius: 50%;
      display: inline-block; margin: 0 8px; background: #ccc;
    }
    .top-buttons {
      display: flex; justify-content: center; align-items: center; gap: 15px;
    }
    #toggleTheme, #toggleSettings {
      background: none; border: none; font-size: 1.8rem;
      cursor: pointer; color: #444; transition: transform 0.4s;
    }
    #toggleTheme.girando { transform: rotate(360deg); }
    #configPanel {
      display: none; position: fixed; top:50%; left:50%;
      transform: translate(-50%, -50%);
      background: #fff; padding: 20px; border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3); width: 300px; text-align: left;
      z-index: 4000;
    }
    #configPanel h3 { margin-bottom: 10px; }
    #configPanel label { display: block; margin: 10px 0; }
    /* Dark mode geral */
    body.dark {
      background: #1c1c1c; color: #f1f1f1;
    }
    body.dark .painel { background: #2b2b2b; border-color: #444; }
    body.dark input, body.dark button, body.dark select {
      background: #3b3b3b; color: #f1f1f1;
    }
    body.dark button { background: #ff4d6d; color: #fff; }
    body.dark button:active { background: #ff3355; }
    body.dark .cor-preview { border-color: #aaa; }
    body.dark #toggleTheme, body.dark #toggleSettings { color: #f1f1f1; }
    /* Dark mode no configPanel */
    body.dark #configPanel {
      background: #2b2b2b; color: #f1f1f1;
    }
    body.dark #configPanel button {
      background: #ff4d6d; color: #fff;
    }
    body.dark #configPanel button:active { background: #ff3355; }
    /* Splash Screen */
    #splashScreen {
      position: fixed; top: 0; left: 0; width:100%; height:100%;
      background: #fdf6f8; display:flex; flex-direction:column;
      align-items:center; justify-content:center; z-index:3000;
      transition: opacity 1s;
    }
    #splashScreen .logo {
      width: clamp(120px,25%,200px); height:auto; margin-bottom:20px;
      image-rendering: pixelated; animation: pulseHeart 1.2s infinite alternate;
    }
    #splashText {
      font-size:1.2rem; color:#ff3366; min-height:50px;
      font-family: 'Inter', sans-serif;
    }
    @keyframes pulseHeart { from {transform:scale(1);} to {transform:scale(1.2);} }
    @keyframes pulseWheel { from {transform:scale(1);} to {transform:scale(1.05);} }
    @media(max-width:500px){
      .painel{width:95%; padding:15px;}
      input,button,select{font-size:1rem;}
    }

     /*CSS para ajustar os Toggles do Config*/
   #configPanel label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
      font-size: 0.95rem;
  }
  #configPanel input[type="checkbox"] {
      transform: scale(1.4);
      accent-color: #ff3366; /* opcional: cor personalizada */
  }

    /*CSS para Hearts*/
    #heart-container {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  pointer-events: none;
  z-index: 100;
}

.heart {
  position: absolute;
  bottom: 0; /* <-- Come√ßa na parte inferior da tela */
  width: 20px;
  height: 20px;
  background-color: #ff3366;
  transform: rotate(45deg);
  animation: float 6s linear infinite;
  opacity: 0.7;
}

.heart::before,
.heart::after {
  content: '';
  position: absolute;
  width: 20px;
  height: 20px;
  background-color: #ff3366;
  border-radius: 50%;
}

.heart::before {
  top: -10px;
  left: 0;
}
.heart::after {
  left: -10px;
  top: 0;
}

@keyframes float {
  0% {
    transform: translateY(0) rotate(45deg);
    opacity: 0.8;
  }
  100% {
    transform: translateY(-100vh) rotate(45deg);
    opacity: 0;
  }
}

.toggle-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  margin: 12px 0;
  font-size: 1rem;
  width: 100%;
}

.toggle-row label {
  flex-grow: 1;
  white-space: nowrap;
}

.toggle-row input[type="checkbox"] {
  transform: scale(1.5);
  accent-color: #ff3366;
  flex-shrink: 0;
}
  
    @media screen and (max-width: 500px) {
  #configPanel {
    width: 90vw;
  }

  .toggle-row {
    font-size: 0.95rem;
    gap: 6px;
  }
      
  .toggle-row label {
    max-width: 80%;
  }
}

  </style>
</head>
<body>
  
  <!-- Splash Screen -->
  <div id="splashScreen">
    <img src="Logo_CallWal.png" alt="Logo Cora√ß√£o" class="logo">
    <p id="splashText"></p>
  </div>

  <!-- Configura√ß√µes -->
 <div id="configPanel">
  <h3>Configura√ß√µes ‚öôÔ∏è</h3>

  <div class="toggle-row">
  <label for="vibrationToggle">Ativar vibra√ß√£o</label>
  <input type="checkbox" id="vibrationToggle" checked>
</div>

<div class="toggle-row">
  <label for="soundEffectToggle">Ativar sons de clique</label>
  <input type="checkbox" id="soundEffectToggle" checked>
</div>

<div class="toggle-row">
  <label for="musicToggle">M√∫sica de fundo</label>
  <input type="checkbox" id="musicToggle" checked>
</div>

<div class="toggle-row">
  <label for="heartToggle">Efeitos de cora√ß√µes</label>
  <input type="checkbox" id="heartToggle" checked>
</div>


  <button onclick="fecharConfig()">Fechar</button>
</div>

  <!-- Efeitos Hearts -->
  <div id="heart-container"></div>

  <div class="painel">
    <div class="top-buttons">
      <button id="toggleTheme">üåô</button>
      <button id="toggleSettings">‚öôÔ∏è</button>
    </div>

    <h2><span class="pulse">‚ù§Ô∏è</span> CallWa <span class="pulse">‚ù§Ô∏è</span></h2>

    <label>Estado de Conex√£o: <span class="status" id="status"></span> <span id="ping">0</span>ms</label>

    <div style="margin-top:10px">
      <label>Enviar para:</label>
      <select id="destino">
        <option value="waleria">Wal√©ria</option>
        <option value="callebe">Callebe</option>
        <option value="ambos">Ambos</option>
      </select>
    </div>

    <div class="botoes-grid">
      <button onclick="clickBtn('saudades')">Te amo ‚ù§Ô∏è</button>
      <button onclick="clickBtn('pensando')">T√¥ pensando em voc√™</button>
      <button onclick="clickBtn('desculpas')">Me desculpa</button>
      <button onclick="clickBtn('to_aqui')">T√¥ aquiii</button>
      <button onclick="clickBtn('surpresinha')">üëÄ</button>
      <button onclick="clickBtn('bajulinho')">Bajulinho</button>
    </div>

    <label>Velocidade:</label>
    <input id="velocidade" type="range" min="0" max="100" value="50"
      oninput="document.getElementById('velLabel').innerText = this.value + '%'">
    <div id="velLabel">50%</div>

    <label style="font-weight:bold">Aspectro de Cor:</label>
    <div id="colorWheel"></div>
    <div class="cor-preview" id="corPreview"></div>

    <div class="botoes-modo">
      <button id="modoEstatico" onclick="enviarModo('estatico', this)">Est√°tico</button>
      <button id="modoBlynk" onclick="clickBtn('aspectro')">Blynk</button>
      <button id="modoSequencial" onclick="enviarModo('sequencial', this)">Sequencial</button>
    </div>

    <div class="esp-status">
      <p>ESP32 Callebe: <span class="esp-led" id="statusCallebe"></span> |
         ESP32 Wal√©ria: <span class="esp-led" id="statusWaleria"></span></p>
    </div>
  </div>

  <script>
    // Elementos
    const statusCircle = document.getElementById('status');
    const pingText     = document.getElementById('ping');
    const ledCallebe   = document.getElementById('statusCallebe');
    const ledWaleria   = document.getElementById('statusWaleria');
    const corPreview   = document.getElementById('corPreview');
    const toggleThemeBtn    = document.getElementById('toggleTheme');
    const toggleSettingsBtn = document.getElementById('toggleSettings');
    const configPanel       = document.getElementById('configPanel');
    const splashText        = document.getElementById('splashText');

    // Estados
    let client, corAtual = '#FFD6E0', lastPing = Date.now(), lastSeen = { ESP_CALL:0, ESP_WAL:0 };
    let vibrationEnabled = true, soundEnabled = true;

    // Toggles vibra√ß√£o e som
    document.getElementById('vibrationToggle').onchange = e => vibrationEnabled = e.target.checked;
    document.getElementById('soundEffectToggle').onchange     = e => soundEnabled     = e.target.checked;

    toggleSettingsBtn.onclick = () => configPanel.style.display = 'block';
    function fecharConfig() { configPanel.style.display = 'none'; }

    // Dark mode init
    if (localStorage.theme === 'dark') {
      document.body.classList.add('dark'); toggleThemeBtn.textContent='‚òÄÔ∏è';
    } else if (localStorage.theme==='light') {
      document.body.classList.remove('dark'); toggleThemeBtn.textContent='üåô';
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.body.classList.add('dark'); toggleThemeBtn.textContent='‚òÄÔ∏è';
    }

    toggleThemeBtn.onclick = ()=>{
      document.body.classList.toggle('dark');
      const dark = document.body.classList.contains('dark');
      toggleThemeBtn.textContent = dark ? '‚òÄÔ∏è' : 'üåô';
      localStorage.setItem('theme', dark?'dark':'light');
      toggleThemeBtn.classList.add('girando');
      setTimeout(()=>toggleThemeBtn.classList.remove('girando'),400);
    };

    // Splash typewriter
    const splashMessage = 
  "Com todo amor de <strong>Callebe Cruz</strong>.<br>" +
  "Uma dedicat√≥ria a <strong>Wal√©ria Val√©rio</strong>.";

let charIndex = 0;
let tempMessage = "";

function typeWriter() {
  const currentChar = splashMessage.charAt(charIndex);
  tempMessage += currentChar;

  splashText.innerHTML = tempMessage; // Interpreta <strong> e <br>

  charIndex++;
  if (charIndex < splashMessage.length) {
    setTimeout(typeWriter, 80);
  }
}



    // Onload: splash + MQTT
    window.onload = () => {
      // splash
      typeWriter();
      
       // iniciar m√∫sica
  backgroundAudio = new Audio('musica.mp3');
  backgroundAudio.loop = true;
  backgroundAudio.volume = parseInt(document.getElementById('musicVolume').value) / 100;

  backgroundAudio.play().catch(() => {
    document.body.addEventListener('click', () => {
      backgroundAudio.play();
    }, { once: true });
  });

      setTimeout(()=>{
        document.getElementById('splashScreen').style.opacity='0';
        setTimeout(()=>{
          document.getElementById('splashScreen').style.display='none';
        },1000);
      },8000);
      // conecta MQTT
      conectarMQTT();
      // detec√ß√£o de IOS
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
if (isIOS) {
  const vol = document.getElementById('musicVolume');
  const label = document.getElementById('label[for="musicVolume"]');
  if (vol) vol.style.display = 'none';
  if (label) label.style.display = 'none';
}

    
    };

// Efeitos Heart Java Script
    function criarCoracao() {
      const heart = document.createElement('div');
          heart.className = 'heart';
          heart.style.left = Math.random() * 100 + 'vw';
          heart.style.animationDuration = (3 + Math.random() * 3) + 's';
          heart.style.transform = `scale(${0.8 + Math.random() * 0.6}) rotate(45deg)`;
          document.getElementById('heart-container').appendChild(heart);

        setTimeout(() => {
        heart.remove();
      }, 6000);
    }

    // Conectar MQTT
    function conectarMQTT(){
      client = mqtt.connect('wss://70d4da565d9c476782999dc9303945b0.s1.eu.hivemq.cloud:8884/mqtt', {
        username:'WEB_CALLWA', password:'Serzinhos2025', clientId:'CallWeb'
      });
      client.on('connect',()=>{
        statusCircle.style.background='green'; lastPing=Date.now();
        client.subscribe('luminaria/ping');
      });
      client.on('message',(topic,msg)=>{
        if(topic==='luminaria/ping'){
          try{
            const p=JSON.parse(msg.toString());
            if(p.id&&p.status==='ok'&&p.id!=='CallWeb'){
              const pv=Date.now()-lastPing;
              pingText.textContent=`${pv}`;
              lastPing=Date.now();
              if(p.id==='ESP_CALL') lastSeen.ESP_CALL=Date.now();
              else if(p.id==='ESP_WAL') lastSeen.ESP_WAL=Date.now();
            }
          }catch{}
        }
      });
      client.on('error',()=>statusCircle.style.background='red');
      client.on('close',()=>statusCircle.style.background='red');
      setInterval(()=>{
        if(client&&client.connected){
          client.publish('luminaria/ping',JSON.stringify({
            id:'CallWeb',from:'web',status:'ok',timestamp:Date.now()
          }));
        }
        const now=Date.now();
        ledCallebe.style.background= now-lastSeen.ESP_CALL<3000?'lime':'#ccc';
        ledWaleria.style.background= now-lastSeen.ESP_WAL<3000?'lime':'#ccc';
      },1000);
    }

    // Feedback t√°til e sonoro
    function playSound(){
      if(!soundEnabled) return;
      const audio = new Audio('https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg');
      audio.volume=0.2; audio.play();
    }
    function clickBtn(efeito){
      if(vibrationEnabled&&navigator.vibrate) navigator.vibrate(50);
      playSound();
      enviarComando(efeito);
    }

    // Envio comando
    function enviarComando(efeito){
      if(!client||!client.connected) return;
      const destino = document.getElementById('destino').value;
      const velocidade = document.getElementById('velocidade').value;
      let dest = destino==='waleria' ? 'ESP_WAL'
               : destino==='callebe'? 'ESP_CALL' : 'ALL';
      const payload={ from:'web', to:dest, efeito, cor:corAtual, velocidade };
      publicarPayload(dest,payload);
    }

    // Envio modo
    function enviarModo(modo,btn){
      if(!client||!client.connected) return;
      const destino = document.getElementById('destino').value;
      let dest = destino==='waleria'? 'ESP_WAL'
               : destino==='callebe'? 'ESP_CALL':'ALL';
      document.querySelectorAll('.botoes-modo button').forEach(b=>b.classList.remove('ativo'));
      btn.classList.add('ativo');
      const payload={ from:'web', to:dest, modo };
      publicarPayload(dest,payload);
    }

    // Publica no t√≥pico correto
    function publicarPayload(dest,payload){
      if(dest==='ALL'){
        client.publish('luminaria/para_voce',JSON.stringify(payload));
        client.publish('luminaria/para_waleria',JSON.stringify(payload));
      } else if(dest==='ESP_CALL'){
        client.publish('luminaria/para_voce',JSON.stringify(payload));
      } else {
        client.publish('luminaria/para_waleria',JSON.stringify(payload));
      }
    }

    // Color wheel
    const colorWheel = new iro.ColorPicker("#colorWheel",{ width:220, color:corAtual, borderWidth:1, borderColor:"#ccc" });
    colorWheel.on("color:change",color=>{
      corAtual=color.hexString;
      corPreview.style.background=corAtual;
    });

    // Efeitos Hearts
  let heartEffectEnabled = true;
document.getElementById('heartToggle').onchange = e => heartEffectEnabled = e.target.checked;

setInterval(() => {
  if (heartEffectEnabled) criarCoracao();
}, 500);


    // M√∫sica de fundo
  let backgroundAudio;
  window.addEventListener('DOMContentLoaded', () => {
    backgroundAudio = new Audio('musica.mp3'); // nome do arquivo no GitHub
    backgroundAudio.loop = true;
    backgroundAudio.volume = 0.5;
    backgroundAudio.play().catch(() => {
      // Autoplay bloqueado, tocar√° com intera√ß√£o
      document.body.addEventListener('click', () => {
        backgroundAudio.play();
      }, { once: true });
    });
  });

  // Controles do som e m√∫sica
const soundEffectToggle = document.getElementById('soundEffectToggle');
const musicToggle = document.getElementById('musicToggle');
const musicVolumeSlider = document.getElementById('musicVolume');

soundEffectToggle.onchange = () => {
  soundEnabled = soundEffectToggle.checked;
};

musicToggle.onchange = () => {
  if (musicToggle.checked) {
    backgroundAudio.play();
  } else {
    backgroundAudio.pause();
  }
};

musicVolumeSlider.oninput = () => {
  const volume = parseInt(musicVolumeSlider.value) / 100;
  backgroundAudio.volume = volume;
};

    
  </script>
</body>
</html>
